localhost {
    # ─────────────────────────────────────────────
    # Reverse proxy to main site, with WAF validation
    # ─────────────────────────────────────────────

    # Match all requests
    route /* {
        # Perform WAF validation
        @validate not path /js_challenge* /pow_challenge* /verify_js /verify_pow /health
        reverse_proxy @validate 127.0.0.1:8080 {
            transport http {
                version 1.1
            }
            header_up Host {host}
            header_up X-Real-IP {remote_host}
            header_up X-Forwarded-For {remote_host}
            header_up User-Agent {user_agent}
            header_up X-Forwarded-Proto {scheme}
        }

        # Capture WAF challenge header
        @js_challenge header X-fantasma0-Challenge js
        @pow_challenge header X-fantasma0-Challenge pow

        # JS challenge
        handle @js_challenge {
            uri /js_challenge
            reverse_proxy 127.0.0.1:8080
        }

        # PoW challenge
        handle @pow_challenge {
            uri /pow_challenge
            reverse_proxy 127.0.0.1:8080
        }

        # Allow normal requests (header not set or verified)
        handle {
            reverse_proxy 127.0.0.1:8080
        }
    }

    # ─────────────────────────────────────────────
    # Direct WAF endpoints
    # ─────────────────────────────────────────────
    route /js_challenge* {
        reverse_proxy 127.0.0.1:8080
    }

    route /pow_challenge* {
        reverse_proxy 127.0.0.1:8080
    }

    route /verify_js {
        reverse_proxy 127.0.0.1:8080
    }

    route /verify_pow {
        reverse_proxy 127.0.0.1:8080
    }

    route /health {
        reverse_proxy 127.0.0.1:8080
    }
}
