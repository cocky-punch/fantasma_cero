<!doctype html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Security Verification</title>
        <style>
            * {
                margin: 0;
                padding: 0;
                box-sizing: border-box;
            }

            body {
                font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen, Ubuntu, sans-serif;
                background: #ffffff;
                color: #000000;
                min-height: 100vh;
                display: flex;
                align-items: center;
                justify-content: center;
                padding: 20px;
            }

            .container {
                max-width: 600px;
                width: 100%;
                background: #ffffff;
                border: 2px solid #000000;
                padding: 40px;
            }

            h1 {
                font-size: 24px;
                font-weight: 600;
                margin-bottom: 20px;
                color: #000000;
            }

            p {
                margin-bottom: 15px;
                line-height: 1.6;
                color: #000000;
            }

            .challenge-box {
                background: #fffacd;
                border: 1px solid #000000;
                padding: 15px;
                margin: 20px 0;
                font-family: monospace;
                font-size: 12px;
                word-break: break-all;
            }

            .challenge-box strong {
                color: #000000;
            }

            .status {
                background: #f5f5f5;
                border: 1px solid #000000;
                padding: 15px;
                margin: 20px 0;
                min-height: 50px;
            }

            .progress-bar {
                width: 100%;
                height: 8px;
                background: #f5f5f5;
                border: 1px solid #000000;
                margin: 20px 0;
                overflow: hidden;
            }

            .progress-fill {
                height: 100%;
                background: #000000;
                width: 0%;
                transition: width 0.3s ease;
            }

            button {
                background: #ffeb3b;
                color: #000000;
                border: 2px solid #000000;
                padding: 15px 30px;
                font-size: 16px;
                font-weight: 600;
                cursor: pointer;
                width: 100%;
                margin-top: 10px;
            }

            button:hover {
                background: #fdd835;
            }

            button:disabled {
                background: #f5f5f5;
                color: #666666;
                cursor: not-allowed;
            }

            .hidden {
                display: none !important;
            }

            .info {
                font-size: 12px;
                color: #666666;
                margin-top: 20px;
                padding-top: 20px;
                border-top: 1px solid #e0e0e0;
            }

            .error {
                background: #ffebee;
                border: 1px solid #c62828;
                color: #c62828;
                padding: 15px;
                margin: 20px 0;
            }
        </style>
    </head>
    <body>
        <div class="container">
            <h1>Security Verification Required</h1>
            <p>To protect against automated access, complete this verification challenge. Or don't if you're a bot.</p>

            <div class="challenge-box">
                <strong>Challenge ID:</strong> {{ nonce }}<br />
                <strong>Difficulty Level:</strong> {{ difficulty }}<br />
                <strong>Algorithm:</strong> {{ algorithm }}<br />
                <strong>Expected Time:</strong> {{ expected_time }}
            </div>

            <div class="status" id="status">
                Click "Start Verification" to begin. Keep this tab active during the process.
            </div>

            <div class="progress-bar">
                <div class="progress-fill" id="progress"></div>
            </div>

            <button id="solveBtn" onclick="solvePow()">Start Verification</button>

            <input type="text" name="website" class="hidden" id="honeypot" value="" />

            <div class="info">By <strong>Fantasma0</strong></div>
        </div>

        {% if algorithm == "argon2" %}
        <script src="https://cdn.jsdelivr.net/npm/argon2-browser@1.18.0/dist/argon2-bundled.min.js"></script>
        {% endif %}

        <script>
            let solving = false;
            let mouseMovements = [];
            let startTime = 0;
            let solution = 0;

            //TODO
            // document.addEventListener('mousemove', (e) => {
            //     if (solving) {
            //         mouseMovements.push({
            //             x: e.clientX,
            //             y: e.clientY,
            //             timestamp: Date.now()
            //         });

            //         if (mouseMovements.length > 50) {
            //             mouseMovements.shift();
            //         }
            //     }
            // });

            async function solvePow() {
                if (solving) return;

                solving = true;
                startTime = Date.now();

                const btn = document.getElementById('solveBtn');
                const status = document.getElementById('status');
                const progress = document.getElementById('progress');

                btn.disabled = true;
                btn.textContent = 'Computing...';
                status.textContent = 'Computing verification proof. Please wait...';

                {% if algorithm == "argon2" %}
                computeArgon2Hash();
                {% elif algorithm == "sha256" %}
                computeSha256Hash();
                {% endif %}
            }


            {% if algorithm == "argon2" %}
            // Argon2 solver
            async function computeArgon2Hash() {
                const nonce = "{{ nonce }}";
                const difficulty = {{ difficulty }};

                try {
                    const input = nonce + '-' + solution;
                    const result = await argon2.hash({
                        pass: input,
                        salt: nonce,
                        time: difficulty,
                        mem: 65536,
                        hashLen: 32,
                        parallelism: 1,
                        type: argon2.ArgonType.Argon2id
                    });

                    const requiredZeros = Math.floor(difficulty / 2);
                    const leadingZeros = '0'.repeat(requiredZeros);

                    if (result.hashHex.startsWith(leadingZeros)) {
                        const timeElapsed = (Date.now() - startTime) / 1000;
                        status.textContent = `Verification complete! (${timeElapsed.toFixed(1)}s)`;
                        progress.style.width = '100%';

                        await submitSolution(nonce, solution);
                        return;
                    }

                    solution++;

                    const timeElapsed = (Date.now() - startTime) / 1000;
                    const progressPercent = Math.min((solution / 50) * 100, 95);
                    progress.style.width = progressPercent + '%';
                    status.textContent = `Computing... Attempt ${solution} (${timeElapsed.toFixed(1)}s)`;

                    setTimeout(computeArgon2Hash, 10);
                } catch (error) {
                    console.error('Error:', error);
                    status.className = 'error';
                    status.textContent = 'An error occurred. Please try again.';
                    btn.disabled = false;
                    btn.textContent = 'Retry Verification';
                    solving = false;
                }
            }

            {% elif algorithm == "sha256" %}
            async function sha256(str) {
                const encoder = new TextEncoder();
                const data = encoder.encode(str);
                const hashBuffer = await crypto.subtle.digest('SHA-256', data);
                const hashArray = Array.from(new Uint8Array(hashBuffer));
                return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
            }

            // SHA-256 solver
            async function computeSha256Hash() {
                const nonce = "{{ nonce }}";
                const difficulty = {{ difficulty }};

                const batchSize = 5000;
                const batchEnd = solution + batchSize;

                for (let i = solution; i < batchEnd; i++) {
                    const input = nonce + '-' + i;
                    const hash = await sha256(input);

                    if (hash.startsWith('0'.repeat(difficulty))) {
                        const timeElapsed = (Date.now() - startTime) / 1000;
                        status.textContent = `Verification complete! (${timeElapsed.toFixed(1)}s, ${i} attempts)`;
                        progress.style.width = '100%';

                        await submitSolution(nonce, i);
                        return;
                    }

                    solution = i + 1;
                }

                const timeElapsed = (Date.now() - startTime) / 1000;
                const progressPercent = Math.min((solution / 50000) * 100, 95);
                progress.style.width = progressPercent + '%';
                status.textContent = `Computing... ${solution.toLocaleString()} attempts (${timeElapsed.toFixed(1)}s)`;

                setTimeout(computeSha256Hash, 1);
            }
            {% endif %}

            async function submitSolution(nonce, solution) {
                const timingData = {
                    totalTime: Date.now() - startTime,
                    mouseEvents: mouseMovements.length,
                    screenWidth: screen.width,
                    screenHeight: screen.height,
                    userAgent: navigator.userAgent
                };

                const formData = new URLSearchParams();
                formData.append('nonce', nonce);
                formData.append('solution', solution.toString());
                formData.append('mouse_movements', JSON.stringify(mouseMovements));
                formData.append('timing_data', JSON.stringify(timingData));
                formData.append('browser_fingerprint', JSON.stringify({
                    screen: { width: screen.width, height: screen.height, colorDepth: screen.colorDepth },
                    timezone: Intl.DateTimeFormat().resolvedOptions().timeZone,
                    language: navigator.language,
                    platform: navigator.platform,
                    cookieEnabled: navigator.cookieEnabled,
                    doNotTrack: navigator.doNotTrack,
                    hardwareConcurrency: navigator.hardwareConcurrency || 0,
                    deviceMemory: navigator.deviceMemory || 0,
                    canvas: getCanvasFingerprint(),
                    webgl: getWebGLFingerprint(),
                    fonts: getAvailableFonts()
                }));
                formData.append('honeypot_field', document.getElementById('honeypot').value);

                try {
                    const response = await fetch('/verify_pow', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                        body: formData
                    });

                    if (response.ok) {
                        window.location.href = "/";
                    } else {
                        document.getElementById('status').className = 'error';
                        document.getElementById('status').textContent = 'Verification failed. Please try again.';
                        document.getElementById('solveBtn').disabled = false;
                        document.getElementById('solveBtn').textContent = 'Retry Verification';
                        solving = false;
                    }
                } catch (error) {
                    document.getElementById('status').className = 'error';
                    document.getElementById('status').textContent = 'Network error. Please try again.';
                    document.getElementById('solveBtn').disabled = false;
                    document.getElementById('solveBtn').textContent = 'Retry Verification';
                    solving = false;
                }
            }

            function getCanvasFingerprint() {
                try {
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    ctx.textBaseline = 'top';
                    ctx.font = '14px Arial';
                    ctx.fillText('Browser fingerprint test', 2, 2);
                    return canvas.toDataURL().slice(-50);
                } catch(e) { return 'error'; }
            }

            function getWebGLFingerprint() {
                try {
                    const canvas = document.createElement('canvas');
                    const gl = canvas.getContext('webgl') || canvas.getContext('experimental-webgl');
                    if (!gl) return 'no-webgl';

                    const renderer = gl.getParameter(gl.RENDERER);
                    const vendor = gl.getParameter(gl.VENDOR);
                    return `${vendor}-${renderer}`.slice(0, 50);
                } catch(e) { return 'error'; }
            }

            function getAvailableFonts() {
                const fonts = ['Arial', 'Times', 'Courier', 'Helvetica', 'Georgia', 'Verdana'];
                const available = [];

                fonts.forEach(font => {
                    const div = document.createElement('div');
                    div.style.fontFamily = font;
                    div.style.fontSize = '12px';
                    div.textContent = 'test';
                    document.body.appendChild(div);

                    const width = div.offsetWidth;
                    document.body.removeChild(div);

                    if (width > 0) available.push(font);
                });

                return available.join(',');
            }
        </script>
    </body>
</html>
